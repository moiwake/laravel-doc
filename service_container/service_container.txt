https://readouble.com/laravel/9https://readouble.com/laravel/9.x/ja/container.html


ğŸŸ¡ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠ
ã‚¯ãƒ©ã‚¹é–“ã®ä¾å­˜ï¼ˆçµåˆï¼‰ã‚’ç®¡ç†ã™ã‚‹å¼·åŠ›ãªç®¡ç†ãƒ„ãƒ¼ãƒ«
â‡’ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¯ãƒ©ã‚¹ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ä¾å­˜æ€§æ³¨å…¥ã«ã‚ˆã‚‹ä¾å­˜æ€§ã®è§£æ±ºã‚’è‡ªå‹•çš„ã«è¡Œãˆã‚‹



ğŸ”µã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¸ã®ç™»éŒ²
bindã€singletonã€instanceã€when
ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ç™»éŒ²ã™ã‚‹ã€‚

https://readouble.com/laravel/9https://readouble.com/laravel/9.x/ja/container.html
çµåˆ



ğŸ”µæ´»ç”¨æ–¹æ³•ï¼šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¨å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®çµåˆ

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼šå…·ä½“çš„ãªå®Ÿè£…ãŒãªã„
å®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å…·ä½“çš„ãªå®Ÿè£…ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹

â‘ ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¤ãƒ³ãƒ‰
$this->app->bind(
    'App\Contracts\EventPusher',
    'App\Services\RedisEventPusher'
);

App\Contracts\EventPusherã¨ã„ã†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ã€App\Services\RedisEventPusherã¨ã„ã†ã‚¯ãƒ©ã‚¹ã«ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã„ã‚‹ã€‚
â‡’ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¯ EventPusherã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãŒå¿…è¦ãªå ´åˆã€è‡ªå‹•çš„ã«RedisEventPusherã‚¯ãƒ©ã‚¹ã‚’æä¾›ã™ã‚‹ã€‚

â‘¡ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ã‚¿ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆ:
use App\Contracts\EventPusher;

public function __construct(EventPusher $pusher)
{
    $this->pusher = $pusher;
}

RedisEventPusherã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ãŸã„ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã€
EventPusherã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ã‚¿ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆã™ã‚‹ã€‚
â‡’ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¯ã€ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹ã¨ãã«ã€
ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å¼•æ•°ã¨ã—ã¦ EventPusherã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«çµã³ã¤ã‘ã‚‰ã‚ŒãŸå…·ä½“çš„ãªã‚¯ãƒ©ã‚¹ï¼ˆRedisEventPusherï¼‰ã‚’è‡ªå‹•çš„ã«æ³¨å…¥ã™ã‚‹ã€‚
â‡’ã“ã®ã‚¯ãƒ©ã‚¹ãŒEventPusherã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«ä¾å­˜ã—ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€RedisEventPusherã‚¯ãƒ©ã‚¹ã¨ã¯ç–çµåˆã«ãªã‚‹ã€‚
â‡’RedisEventPusherã‚¯ãƒ©ã‚¹ã®å¤‰æ›´ãŒã“ã®ã‚¯ãƒ©ã‚¹ã«ã¯å½±éŸ¿ã—ãªã„ã€‚



ğŸ”µã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚‹çµåˆï¼ˆä½¿ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ã”ã¨ã«ã€ç•°ãªã‚‹ã‚¯ãƒ©ã‚¹ã‚„å€¤åŒå£«ã‚’çµåˆã™ã‚‹ï¼‰

ãƒ¼ã€€whenãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨
ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ãŒä¾å­˜è§£æ±ºã‚’è¡Œã†éš›ã«ã€ãã®ä¾å­˜æ€§ã‚’æŒ‡å®šã—ãŸã‚¯ãƒ©ã‚¹ã‚„å€¤ã«çµã³ã¤ã‘ã‚‹ã€‚

ä¾‹ï¼‰PhotoControllerã¨ã€VideoControllerãƒ»UploadControllerã¯åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ãŒã€
ã€€ã€€ãã®å®Ÿè£…ã®ä¸­èº«ã¯åˆ¥ã®ã‚‚ã®ã«ã—ãŸã„ã€‚

$this->app->when(PhotoController::class)ã€€ã€€PhotoControllerãŒ
          ->needs(Filesystem::class)ã€€ã€€Filesystemã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ä¾å­˜ã—ã¦ã„ã‚‹ã¨ã
          ->give(function () {
              return Storage::disk('local');ã€€ã€€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’è¿”ã™
          });

$this->app->when([VideoController::class, UploadController::class])
          ->needs(Filesystem::class)
          ->give(function () {
              return Storage::disk('s3');
          });

Filesystemã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å…·ä½“çš„ãªå®Ÿè£…ã‚’giveãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã§å®šç¾©ã—ã¦ã„ã‚‹ã€‚

PhotoControllerã‚¯ãƒ©ã‚¹ãŒFilesystemã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¸ã®ä¾å­˜æ€§ã‚’æŒã£ã¦ã„ã¦ã€ãã®ä¾å­˜æ€§ã‚’è§£æ±ºã™ã‚‹ã¨ãã«giveãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã€
giveãƒ¡ã‚½ãƒƒãƒ‰å†…ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ãŒå‘¼ã³å‡ºã•ã‚Œã€Storage::disk('local')ãŒFilesystemã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ä¾å­˜æ€§ã¨ã—ã¦æ³¨å…¥ã•ã‚Œã‚‹ã€‚
â‡’Filesystemã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®è¿”ã‚Šå€¤ãŒStorage::disk('local')ã«ãªã‚‹ï¼Ÿ



ğŸ”µè¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ã®çµåˆã‚’ã¾ã¨ã‚ã¦è§£æ±ºã™ã‚‹
ã‚¿ã‚°ã‚’ä»˜ã‘ãŸè¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã¾ã¨ã‚ã¦å–å¾—ã§ãã‚‹...ã‚¿ã‚°ä»˜ã‘
â‡’å‘¼ã³å‡ºã—å´ã¯ã‚¿ã‚°ä»˜ã‘ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã®å…·ä½“çš„ãªå†…å®¹ã¯çŸ¥ã‚‰ãªãè‰¯ã„ï¼ˆç–çµåˆã«ãªã‚‹ï¼‰

$this->app->tag(['Class1', 'Class2'], 'tag_name');


ä¾‹ï¼‰ReportAggregatorã¯ã€SpeedReportã¨MemoryReportã‚’å«ã‚€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼•æ•°ã«æŒã¤ã¨ã™ã‚‹ã€‚

// SpeedReport ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…
$this->app->bind('SpeedReport', function () {
    return new SpeedReport();
});

// MemoryReport ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…
$this->app->bind('MemoryReport', function () {
    return new MemoryReport();
});

// reports ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹
$this->app->tag(['SpeedReport', 'MemoryReport'], 'reports');

// ReportAggregator ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…
$this->app->bind('ReportAggregator', function ($app) {
    return new ReportAggregator($app->tagged('reports'));ã€€ã€€ã‚¿ã‚°ä»˜ã‘ã—ãŸã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã¾ã¨ã‚ã¦å–å¾—ã§ãã‚‹ = ç–çµåˆ
});

// ReportAggregator ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å–å¾—
$reportAggregator = $this->app->make('ReportAggregator');


â€»ã‚¿ã‚°ã‚’ä½¿ç”¨ã—ãªã‹ã£ãŸå ´åˆ
// ReportAggregator ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ï¼ˆå„ãƒ¬ãƒãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚’ç›´æ¥æ³¨å…¥ï¼‰
$this->app->bind('ReportAggregator', function ($app) {
    $speedReport = $app->make('SpeedReport');
    $memoryReport = $app->make('MemoryReport');
    
    return new ReportAggregator($speedReport, $memoryReport);  å¼•æ•°ã«ã‚¯ãƒ©ã‚¹ã‚’åˆ—æŒ™ = çµåˆãŒå¼·ã„
});



ğŸ”µçµåˆã®å¤‰æ›´
extendãƒ¡ã‚½ãƒƒãƒ‰ï¼šã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠãŒç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è§£æ±ºã™ã‚‹ã¨ãã«ã€ãã®çµæœã‚’ä¿®æ­£ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰

$this->app->extend(Service::class, function ($service, $app) {
    return new DecoratedService($service);
});

Serviceã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ãŒè§£æ±ºã•ã‚Œã‚‹ãŸã³ã«ã€ãã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã—ãŸDecoratedServiceã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã€‚
â‡’æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦è¿½åŠ ã®æ©Ÿèƒ½ã‚„ä¿®æ­£ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚
â‡’ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‹•çš„ã«èª¿æ•´ã™ã‚‹ãŸã‚ã®æ‰‹æ®µã¨ã—ã¦æœ‰ç”¨ã€‚



ğŸ”µä¾å­˜è§£æ±ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
è©³ç´°ã¯ã‚¬ã‚¤ãƒ‰å‚ç…§

make
resolveï¼š$appå¤‰æ•°ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´æ‰€ã§ä¾å­˜è§£æ±ºã—ãŸã„å ´åˆã«ä½¿ãˆã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªresolveãƒ˜ãƒ«ãƒ‘
makeWithï¼šä¾å­˜ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã®å¼•æ•°ãŒã€ã‚¯ãƒ©ã‚¹ä»¥å¤–ï¼ˆãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ï¼‰ã‚’å«ã‚€ã¨ãã«ä½¿ç”¨



ğŸ”µã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ™ãƒ³ãƒˆ
ã‚³ãƒ³ãƒ†ãƒŠã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜è§£æ±ºæ™‚ã«æ¯å›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹

resolvingï¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã§ãã‚‹



ğŸ”µã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä½¿ç”¨ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
PSR-11ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ã€‚
â‡’PSR-11ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ã‚¿ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆã§æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã§ãã‚‹ã€‚

use Psr\Container\ContainerInterface;

Route::get('/', function (ContainerInterface $container) {
    $service = $container->get('Service');ã€€ã€€$containerã«ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå…¥ã‚‹
    //
});

ãƒ¼ã€€ã©ã‚“ãªã¨ãã«ä½¿ç”¨ã™ã‚‹ã‹
ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—ã—ãŸã¨ãã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã©

ä¾‹ï¼‰
Route::get('/', function (ContainerInterface $container) {
    try {
        $service = $container->get('Service');ã€€ã€€Serviceã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—
        //
    } catch (Psr\Container\NotFoundExceptionInterface $e) {
        // ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®å‡¦ç†
    } catch (Psr\Container\ContainerExceptionInterface $e) {
        // ä¾å­˜è§£æ±ºãŒã§ããªã„å ´åˆã®å‡¦ç†
    }
});
